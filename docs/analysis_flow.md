# 区块链行为分析流程

## 分析流程图

```
用户查询
   |
   v
解析查询参数 (地址、区块范围等)
   |
   v
判断地址类型 -------> 普通EOA账户 -------> 普通转账分析流程
   |                                       |
   | 合约账户                               v
   v                                  收集转账交易数据
构建交易调用图                             |
   |                                       v
   v                              分析转账模式 (频率、金额分布等)
调用图是否为空? ----是-----> 普通转账分析流程
   |                                       |
   | 否                                    v
   v                              分析地址特征 (余额、历史等)
合约安全分析流程                            |
   |                                       v
   v                                  LLM生成转账分析报告
执行Rugpull检测                             |
   |                                       v
   v                                  输出最终报告
生成初步分析
   |
   v
详细行为分析
   |
   v
LLM生成最终报告
   |
   v
输出最终报告
```

## 详细流程说明

### 1. 用户查询处理

- 系统接收用户查询，通常是一个包含地址和区块范围的请求
- 调用`parse_user_query`函数解析出查询参数
- 确保必要参数（地址、起始区块、结束区块）存在

### 2. 地址类型判断

- 使用Web3库检查目标地址是否为合约账户
  ```python
  code = w3.eth.get_code(checksum_address)
  is_contract = len(code) > 2  # 非空代码表示是合约
  ```
- 判断结果决定后续分析路径

### 3A. 普通转账分析流程

- 当目标是EOA账户或合约调用图为空时触发
- 执行步骤：
  1. 收集转账交易数据
  2. 分析转账模式（拆分交易、快速转入转出等）
  3. 分析地址特征（余额、交易历史等）
  4. 使用专用提示词让LLM生成分析报告
  5. 保存并输出最终报告

### 3B. 合约安全分析流程

- 当目标是合约账户且调用图不为空时触发
- 执行步骤：
  1. 构建交易调用图
  2. 执行Rugpull检测
  3. 生成初步安全分析
  4. 执行详细行为分析
  5. 使用安全分析提示词让LLM生成最终报告
  6. 保存并输出最终报告

## 分流决策逻辑

系统使用两个关键点来决定分析流程：

1. **地址类型检查**：在`process_user_query`和`execute_full_analysis`函数中，检查目标地址是否为合约
   ```python
   if not is_contract:
       # 进入普通转账分析流程
   ```

2. **调用图检查**：在构建交易调用图后，检查其是否为空
   ```python
   if not call_graph:
       # 进入普通转账分析流程
   ```

这种双重检查机制确保了系统能够根据实际情况选择最适合的分析流程，提高分析的准确性和效率。 